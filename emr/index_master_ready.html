<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pediatric GI Master Registry</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background:#f7f7fb; }
.sidebar { max-height:90vh; overflow-y:auto; border-right:1px solid #ddd; }
.patient-item { cursor:pointer; }
.patient-item.active { background:#e0f3ff; }
.visit-card { border-left:4px solid #0d6efd; }
textarea { font-size:0.85rem; }
.small-label { font-size:0.75rem; color:#666; text-transform:uppercase; }
</style>
</head>
<body>

<nav class="navbar navbar-light bg-white border-bottom mb-2">
<div class="container-fluid">
<span class="fw-semibold">Pediatric GI Academic Registry</span>
</div>
</nav>

<div class="container-fluid">
<div class="row">

<div class="col-md-3 sidebar bg-white p-2">
<h6>Patients</h6>
<input type="text" id="searchBox" class="form-control form-control-sm mb-2" placeholder="Search patient...">
<ul id="patientList" class="list-group"></ul>
</div>

<div class="col-md-9">
<div id="noPatient" class="p-4 text-muted">
Select a patient from the sidebar.
</div>

<div id="patientDetail" class="d-none p-2">
<h5 id="patientName"></h5>
<div id="patientDob" class="small text-muted mb-3"></div>
<h6>Visits</h6>
<div id="visitList" class="d-flex flex-column gap-2 mb-3"></div>
<h6>Selected Visit (Full Encounter JSON)</h6>
<textarea id="visitJson" rows="18" class="form-control"></textarea>
</div>

</div>
</div>
</div>

<script>
let patients = [];
let selectedPatientIndex = null;

async function loadMasterJSON() {
    const response = await fetch("Pediatric_GI_Master_COMPLETE.json");
    const master = await response.json();
    patients = transformToPatients(master);
    renderPatients();
}

function transformToPatients(master) {
    const map = {};
    master.forEach(period => {
        if (!period.Encounters) return;
        period.Encounters.forEach(enc => {
            const template = enc["Comprehensive Pediatric GI Encounter Template"];
            if (!template) return;
            const info = template["1. Encounter Information"];
            if (!info) return;
            const name = info["Patient Name"] || "Unknown";
            const dob = info["DOB / Age"] || "";
            const key = name + "__" + dob;
            if (!map[key]) {
                map[key] = { name:name, dob:dob, visits:[] };
            }
            map[key].visits.push({
                encounterId: enc.EncounterID,
                date: info["Date / Time"] || "",
                visitType: info["Visit Type"] || "",
                full: template
            });
        });
    });
    return Object.values(map);
}

function renderPatients() {
    const list = document.getElementById("patientList");
    list.innerHTML = "";
    patients.forEach((p,index)=>{
        const li=document.createElement("li");
        li.className="list-group-item patient-item";
        li.innerHTML=`<div class="fw-semibold">${p.name}</div>
                      <div class="small text-muted">${p.dob}</div>
                      <div class="small text-muted">${p.visits.length} visit(s)</div>`;
        li.onclick=()=>selectPatient(index);
        list.appendChild(li);
    });
}

function selectPatient(index){
    selectedPatientIndex=index;
    const p=patients[index];
    document.getElementById("noPatient").classList.add("d-none");
    document.getElementById("patientDetail").classList.remove("d-none");
    document.getElementById("patientName").innerText=p.name;
    document.getElementById("patientDob").innerText=p.dob;
    renderVisits();
}

function renderVisits(){
    const visitList=document.getElementById("visitList");
    visitList.innerHTML="";
    const p=patients[selectedPatientIndex];
    p.visits.sort((a,b)=> new Date(b.date)-new Date(a.date));
    p.visits.forEach((visit)=>{
        const card=document.createElement("div");
        card.className="card visit-card p-2";
        card.innerHTML=`<div class="d-flex justify-content-between">
                            <div>
                                <div class="fw-semibold">${visit.date}</div>
                                <div class="small text-muted">${visit.visitType}</div>
                            </div>
                            <button class="btn btn-sm btn-outline-primary">View</button>
                        </div>`;
        card.querySelector("button").onclick=()=>{
            document.getElementById("visitJson").value=JSON.stringify(visit.full,null,2);
        };
        visitList.appendChild(card);
    });
}

document.getElementById("searchBox").addEventListener("input",function(){
    const q=this.value.toLowerCase();
    const items=document.querySelectorAll("#patientList li");
    items.forEach(i=>{
        i.style.display=i.innerText.toLowerCase().includes(q)?"":"none";
    });
});

document.addEventListener("DOMContentLoaded",loadMasterJSON);
</script>

</body>
</html>