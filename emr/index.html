<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Al Farabi Pediatric GI EMR / Registry</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
  />
  <style>
    body {
      background-color: #f7f7fb;
    }
    .sidebar {
      max-height: 90vh;
      overflow-y: auto;
      border-right: 1px solid #ddd;
    }
    .patient-item {
      cursor: pointer;
    }
    .patient-item.active {
      background-color: #e0f3ff;
    }
    textarea {
      font-size: 0.9rem;
    }
    .small-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      color: #666;
    }
    .visit-card {
      border-left: 4px solid #0d6efd;
    }
    .badge-visit {
      font-size: 0.7rem;
    }
    /* Lock screen */
    .lock-screen {
      position: fixed;
      inset: 0;
      background: #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .lock-screen .card {
      max-width: 360px;
      width: 100%;
    }

    /* =========================
       PRINT / PDF STYLES
       ========================= */
    @media print {
      /* Hide everything by default */
      body * {
        visibility: hidden !important;
      }

      /* Show only printArea */
      #printArea, #printArea * {
        visibility: visible !important;
      }

      /* Make printArea fill page */
      #printArea {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        padding: 18px;
        background: white !important;
        color: black !important;
      }

      /* Remove UI-only elements if they accidentally appear */
      button, nav, .sidebar, .modal, .lock-screen {
        display: none !important;
      }

      /* Better printed text */
      h1, h2, h3, h4, h5, h6 {
        page-break-after: avoid;
      }
      .print-block {
        page-break-inside: avoid;
        margin-bottom: 12px;
      }
      .print-small {
        font-size: 12px;
        color: #333;
      }
      .print-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 6px;
      }
      .print-subtitle {
        font-size: 13px;
        margin-bottom: 10px;
      }
      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <!-- PIN LOCK SCREEN -->
  <div id="lockScreen" class="lock-screen">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title mb-2" id="lockTitle">Set up a PIN for this EMR</h5>
        <p class="small text-muted" id="lockSubtitle">
          Choose a 4–8 digit PIN to protect access to this EMR on <strong>this device</strong>.
        </p>
        <div class="mb-2">
          <label class="form-label small mb-1" id="lockLabel">New PIN</label>
          <input
            type="password"
            class="form-control form-control-sm"
            id="lockPinInput"
            inputmode="numeric"
            autocomplete="off"
          />
        </div>
        <div class="mb-2" id="lockConfirmGroup">
          <label class="form-label small mb-1">Confirm PIN</label>
          <input
            type="password"
            class="form-control form-control-sm"
            id="lockPinConfirm"
            inputmode="numeric"
            autocomplete="off"
          />
        </div>
        <div class="text-danger small mb-2" id="lockError"></div>
        <button class="btn btn-primary btn-sm w-100" id="lockBtn">
          Set PIN &amp; unlock
        </button>
        <p class="small text-muted mt-2 mb-0">
          Note: PIN and all patient data are stored locally in this browser.
          Clearing browser data will remove the PIN <strong>and</strong> the EMR data.
        </p>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="appMain" class="d-none">
    <nav class="navbar navbar-light bg-white border-bottom mb-2">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h5">
          Al Farabi Pediatric GI – Mini EMR / Registry
        </span>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary btn-sm" id="btnExport">
            Backup (Export JSON)
          </button>
          <label class="btn btn-outline-secondary btn-sm mb-0">
            Restore
            <input type="file" id="importFile" hidden />
          </label>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <!-- LEFT: patients -->
        <div class="col-12 col-md-3 sidebar bg-white p-2">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Patients</h6>
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#patientModal">
              + New
            </button>
          </div>
          <input
            type="text"
            id="patientSearch"
            class="form-control form-control-sm mb-2"
            placeholder="Search name / phone..."
          />
          <ul class="list-group" id="patientList"></ul>
        </div>

        <!-- RIGHT: details -->
        <div class="col-12 col-md-9">
          <div id="noPatientSelected" class="text-muted p-4">
            Select a patient or create a new one.
          </div>

          <div id="patientDetail" class="d-none p-2">
            <!-- Patient header -->
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <h5 id="detailName"></h5>
                <div class="small-label" id="detailId"></div>
                <div class="small text-muted" id="detailDemographics"></div>
              </div>
              <div class="d-flex gap-2 flex-wrap justify-content-end">
                <button
                  class="btn btn-outline-secondary btn-sm"
                  id="btnEditPatient"
                >
                  Edit Patient
                </button>

                <button
                  class="btn btn-outline-primary btn-sm"
                  id="btnExportPatient"
                >
                  Export history
                </button>

                <button class="btn btn-outline-success btn-sm" id="btnPrintPatientPdf">
                  Print / Save PDF (Patient)
                </button>

                <button class="btn btn-outline-success btn-sm" id="btnPrintVisitPdf" title="Print the currently selected visit (click Details first)">
                  Print / Save PDF (Visit)
                </button>
              </div>
            </div>

            <!-- Visit creation -->
            <div class="card mb-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span>New Visit</span>
                <span class="badge bg-info text-dark badge-visit">
                  Enter note in English, summaries will be EN/AR/KU via ChatGPT or AI button
                </span>
              </div>
              <div class="card-body">
                <form id="visitForm">
                  <div class="row g-2">
                    <div class="col-md-3">
                      <label class="form-label required">Date</label>
                      <input
                        type="date"
                        class="form-control form-control-sm"
                        id="visitDate"
                        required
                      />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label required">Visit type</label>
                      <select
                        class="form-select form-select-sm"
                        id="visitType"
                        required
                      >
                        <option value="New consultation">New consultation</option>
                        <option value="Follow-up">Follow-up</option>
                        <option value="Urgent">Urgent</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label required">Chief complaint</label>
                      <input
                        type="text"
                        class="form-control form-control-sm"
                        id="visitCC"
                        required
                      />
                    </div>
                  </div>

                  <div class="row g-2 mt-1">
                    <div class="col-md-6">
                      <label class="form-label">HPI (History of Present Illness)</label>
                      <textarea
                        class="form-control form-control-sm"
                        rows="3"
                        id="visitHPI"
                      ></textarea>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Past history / Meds / Allergies</label>
                      <textarea
                        class="form-control form-control-sm"
                        rows="3"
                        id="visitPMH"
                      ></textarea>
                    </div>
                  </div>

                  <div class="row g-2 mt-1">
                    <div class="col-md-4">
                      <label class="form-label">Vitals</label>
                      <textarea
                        class="form-control form-control-sm"
                        rows="2"
                        id="visitVitals"
                        placeholder="HR, RR, BP, Temp, Wt, Ht, BMI, centiles..."
                      ></textarea>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Exam – General / Abdomen</label>
                      <textarea
                        class="form-control form-control-sm"
                        rows="2"
                        id="visitExam"
                      ></textarea>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Other exam findings</label>
                      <textarea
                        class="form-control form-control-sm"
                        rows="2"
                        id="visitOtherExam"
                      ></textarea>
                    </div>
                  </div>

                  <div class="row g-2 mt-1">
                    <div class="col-md-6">
                      <label class="form-label required">Impression / Diagnosis</label>
                      <textarea
                        class="form-control form-control-sm"
                        rows="2"
                        id="visitImpression"
                        required
                      ></textarea>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Plan – Investigations (labs, imaging, scopes)</label>
                      <textarea
                        class="form-control form-control-sm"
                        rows="2"
                        id="visitPlanInvestigations"
                      ></textarea>
                    </div>
                  </div>

                  <div class="row g-2 mt-1">
                    <div class="col-md-6">
                      <label class="form-label">Plan – Medications</label>
                      <textarea
                        class="form-control form-control-sm"
                        rows="2"
                        id="visitPlanMeds"
                      ></textarea>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Plan – Diet / Counseling / Follow-up</label>
                      <textarea
                        class="form-control form-control-sm"
                        rows="2"
                        id="visitPlanCounsel"
                      ></textarea>
                    </div>
                  </div>

                  <div class="row g-2 mt-1">
                    <div class="col-md-4">
                      <label class="form-label">Follow-up interval</label>
                      <select
                        class="form-select form-select-sm"
                        id="visitFollowInterval"
                      >
                        <option value="">PRN</option>
                        <option value="1 week">1 week</option>
                        <option value="2 weeks">2 weeks</option>
                        <option value="1 month">1 month</option>
                        <option value="3 months">3 months</option>
                        <option value="6 months">6 months</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Next follow-up date</label>
                      <input
                        type="date"
                        class="form-control form-control-sm"
                        id="visitNextDate"
                      />
                    </div>
                    <div class="col-md-4 d-flex align-items-end justify-content-end">
                      <button type="submit" class="btn btn-success btn-sm w-100">
                        Save visit
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>

            <!-- Visit list + ChatGPT + Orders + AI -->
            <div class="row g-3">
              <div class="col-md-7">
                <h6>Previous Visits</h6>
                <div id="visitList" class="d-flex flex-column gap-2"></div>
              </div>
              <div class="col-md-5">
                <h6>ChatGPT Summary Helper (manual)</h6>
                <p class="small text-muted">
                  Select a visit below, then click "Copy prompt" to generate parent-friendly summaries
                  in <strong>English, Arabic and Kurdish</strong> using ChatGPT.
                </p>
                <textarea
                  id="chatgptPrompt"
                  class="form-control form-control-sm mb-2"
                  rows="6"
                  readonly
                ></textarea>
                <button class="btn btn-outline-primary btn-sm mb-3" id="btnCopyPrompt">
                  Copy prompt text
                </button>

                <hr class="my-2" />
                <h6>AI Summary (via Cloudflare Worker)</h6>
                <p class="small text-muted">
                  After you configure your backend URL, click the button to automatically generate EN / AR / KU summaries
                  for the selected visit.
                </p>
                <button class="btn btn-primary btn-sm mb-2" id="btnGenerateAiSummary">
                  Generate AI summaries for selected visit
                </button>
                <div class="small text-danger mb-1" id="aiError"></div>
                <label class="form-label small mb-0 mt-1">English summary</label>
                <textarea id="aiSummaryEn" class="form-control form-control-sm mb-1" rows="3"></textarea>
                <button class="btn btn-outline-secondary btn-sm mb-2" id="btnCopyAiEn">
                  Copy English
                </button>
                <label class="form-label small mb-0">Arabic summary</label>
                <textarea id="aiSummaryAr" class="form-control form-control-sm mb-1" rows="3"></textarea>
                <button class="btn btn-outline-secondary btn-sm mb-2" id="btnCopyAiAr">
                  Copy Arabic
                </button>
                <label class="form-label small mb-0">Kurdish summary</label>
                <textarea id="aiSummaryKu" class="form-control form-control-sm mb-1" rows="3"></textarea>
                <button class="btn btn-outline-secondary btn-sm mb-2" id="btnCopyAiKu">
                  Copy Kurdish
                </button>

                <hr class="my-2" />
                <h6>Orders (labs / imaging / scopes) for selected visit</h6>
                <p class="small text-muted">
                  Click "Details" on a visit first, then use this form to add tests for that visit.
                </p>
                <form id="orderForm" class="border rounded p-2 mb-2 small">
                  <div class="mb-1">
                    <label class="form-label small mb-0">Type</label>
                    <select class="form-select form-select-sm" id="orderType">
                      <option value="Lab">Lab</option>
                      <option value="Imaging">Imaging</option>
                      <option value="Endoscopy">Endoscopy</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                  <div class="mb-1">
                    <label class="form-label small mb-0">Test / procedure name</label>
                    <input
                      type="text"
                      class="form-control form-control-sm"
                      id="orderName"
                      placeholder="CBC, TTG IgA, Abdominal US, EGD..."
                    />
                  </div>
                  <div class="mb-1">
                    <label class="form-label small mb-0">Ordered date</label>
                    <input type="date" class="form-control form-control-sm" id="orderDate" />
                  </div>
                  <div class="mb-1">
                    <label class="form-label small mb-0">Status</label>
                    <select class="form-select form-select-sm" id="orderStatus">
                      <option value="Ordered">Ordered</option>
                      <option value="Pending result">Pending result</option>
                      <option value="Resulted">Resulted</option>
                      <option value="Cancelled">Cancelled</option>
                    </select>
                  </div>
                  <div class="mb-1">
                    <label class="form-label small mb-0">Result date (if available)</label>
                    <input type="date" class="form-control form-control-sm" id="orderResultDate" />
                  </div>
                  <div class="mb-1">
                    <label class="form-label small mb-0">Result summary / notes</label>
                    <textarea
                      class="form-control form-control-sm"
                      rows="2"
                      id="orderResultText"
                    ></textarea>
                  </div>
                  <button type="submit" class="btn btn-outline-success btn-sm w-100">
                    Add order to this visit
                  </button>
                </form>
                <div id="orderList" class="small"></div>
              </div>
            </div>
          </div>
        </div> <!-- /right col -->
      </div>
    </div>
  </div>

  <!-- Patient modal -->
  <div
    class="modal fade"
    id="patientModal"
    tabindex="-1"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <form id="patientForm">
          <div class="modal-header">
            <h5 class="modal-title" id="patientModalTitle">New Patient</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row g-2">
              <div class="col-md-4">
                <label class="form-label required">Patient ID</label>
                <input
                  type="text"
                  class="form-control form-control-sm"
                  id="patId"
                  required
                  placeholder="e.g. AF-0001"
                />
              </div>
              <div class="col-md-8">
                <label class="form-label required">Full Name (English)</label>
                <input
                  type="text"
                  class="form-control form-control-sm"
                  id="patNameEn"
                  required
                />
              </div>
            </div>

            <div class="row g-2 mt-1">
              <div class="col-md-6">
                <label class="form-label">Full Name (Arabic)</label>
                <input
                  type="text"
                  class="form-control form-control-sm"
                  id="patNameAr"
                />
              </div>
              <div class="col-md-6">
                <label class="form-label">Full Name (Kurdish)</label>
                <input
                  type="text"
                  class="form-control form-control-sm"
                  id="patNameKu"
                />
              </div>
            </div>

            <div class="row g-2 mt-1">
              <div class="col-md-4">
                <label class="form-label">Date of Birth</label>
                <input
                  type="date"
                  class="form-control form-control-sm"
                  id="patDob"
                />
              </div>
              <div class="col-md-4">
                <label class="form-label">Sex</label>
                <select
                  class="form-select form-select-sm"
                  id="patSex"
                >
                  <option value=""></option>
                  <option>Male</option>
                  <option>Female</option>
                  <option>Other</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Phone / WhatsApp</label>
                <input
                  type="text"
                  class="form-control form-control-sm"
                  id="patPhone"
                />
              </div>
            </div>

            <div class="row g-2 mt-1">
              <div class="col-md-6">
                <label class="form-label">City / Area</label>
                <input
                  type="text"
                  class="form-control form-control-sm"
                  id="patCity"
                />
              </div>
              <div class="col-md-6">
                <label class="form-label">Referral Source</label>
                <input
                  type="text"
                  class="form-control form-control-sm"
                  id="patReferral"
                  placeholder="Self, pediatrician, hospital, social media..."
                />
              </div>
            </div>

            <div class="row g-2 mt-1">
              <div class="col-md-6">
                <label class="form-label">Primary caregiver name</label>
                <input
                  type="text"
                  class="form-control form-control-sm"
                  id="patCaregiver"
                />
              </div>
              <div class="col-md-6">
                <label class="form-label">Relationship</label>
                <input
                  type="text"
                  class="form-control form-control-sm"
                  id="patCaregiverRel"
                  placeholder="Mother, father, grandparent..."
                />
              </div>
            </div>

            <div class="mt-2">
              <label class="form-label">Notes / Flags (IBD, Celiac, complex etc.)</label>
              <textarea
                class="form-control form-control-sm"
                rows="2"
                id="patNotes"
              ></textarea>
            </div>

            <input type="hidden" id="patEditIndex" />
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary btn-sm"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-primary btn-sm">
              Save patient
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Patient export modal -->
  <div class="modal fade" id="patientExportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Export patient history</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="small text-muted">
            This text includes demographics, all visits, and orders. Copy and paste into a referral letter or report.
          </p>
          <textarea id="patientExportText" class="form-control form-control-sm" rows="20"></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary btn-sm" id="btnCopyPatientExport">Copy text</button>
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PRINT AREA (hidden, used for Print/PDF) -->
  <div id="printArea" class="d-none"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ====== CONFIG ======
    // Replace this with your Cloudflare Worker URL when ready, e.g.:
    // const AI_SUMMARY_ENDPOINT = "https://your-worker-name.your-subdomain.workers.dev/summary";
    const AI_SUMMARY_ENDPOINT = ""; // empty = disabled, will show error

    // ====== DATA STRUCTURES ======
    let patients = [];
    let visits = [];
    let orders = [];
    let selectedPatientId = null;
    let currentVisitIdForOrders = null;
    let lastSelectedVisit = null;

    const LS_PATIENTS_KEY = "af_emr_patients";
    const LS_VISITS_KEY = "af_emr_visits";
    const LS_ORDERS_KEY = "af_emr_orders";
    const PIN_KEY = "af_emr_pin";

    function loadData() {
      try {
        const p = localStorage.getItem(LS_PATIENTS_KEY);
        const v = localStorage.getItem(LS_VISITS_KEY);
        const o = localStorage.getItem(LS_ORDERS_KEY);
        patients = p ? JSON.parse(p) : [];
        visits = v ? JSON.parse(v) : [];
        orders = o ? JSON.parse(o) : [];
      } catch (e) {
        console.error("Error loading data", e);
        patients = [];
        visits = [];
        orders = [];
      }
    }

    function saveData() {
      localStorage.setItem(LS_PATIENTS_KEY, JSON.stringify(patients));
      localStorage.setItem(LS_VISITS_KEY, JSON.stringify(visits));
      localStorage.setItem(LS_ORDERS_KEY, JSON.stringify(orders));
    }

    // ====== PRINT / SAVE PDF HELPERS ======
    function safeFilenamePart(s) {
      return (s || "")
        .toString()
        .trim()
        .replace(/\s+/g, "_")
        .replace(/[^A-Za-z0-9_-]/g, "");
    }

    function buildPdfFilename(patient, suffix) {
      const name = safeFilenamePart(patient?.nameEn || "Patient");
      const dob = safeFilenamePart(patient?.dob || "DOB");
      const today = new Date().toISOString().slice(0, 10);
      const extra = safeFilenamePart(suffix || "");
      return `${name}_${dob}${extra ? "_" + extra : ""}_${today}.pdf`;
    }

    function setPrintAreaHtml(html) {
      const pa = document.getElementById("printArea");
      pa.innerHTML = html;
      pa.classList.remove("d-none");
    }

    function clearPrintArea() {
      const pa = document.getElementById("printArea");
      pa.innerHTML = "";
      pa.classList.add("d-none");
    }

    function printHtmlWithFilename(filename, html) {
      const oldTitle = document.title;
      document.title = filename; // default PDF filename in many browsers
      setPrintAreaHtml(html);

      setTimeout(() => {
        window.print();
        setTimeout(() => {
          clearPrintArea();
          document.title = oldTitle;
        }, 500);
      }, 50);
    }

    function buildPatientPrintHtml(patientId) {
      const p = getPatientById(patientId);
      if (!p) return "";

      const text = buildPatientHistoryText(patientId);
      const safeText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");

      return `
        <div class="print-block">
          <div class="print-title">Al Farabi Pediatric GI – Patient Record</div>
          <div class="print-subtitle">
            <strong>Patient:</strong> ${p.nameEn || ""} &nbsp; | &nbsp;
            <strong>DOB:</strong> ${p.dob || "N/A"} &nbsp; | &nbsp;
            <strong>ID:</strong> ${p.id || ""} &nbsp; | &nbsp;
            <strong>Phone:</strong> ${p.phone || ""}
          </div>
          <div class="print-small">Generated: ${new Date().toLocaleString()}</div>
          <hr />
          <pre>${safeText}</pre>
        </div>
      `;
    }

    function buildVisitPrintHtml(visitObj) {
      const p = getPatientById(visitObj?.patientId);
      if (!p || !visitObj) return "";

      const note = makeClinicalNoteText(p, visitObj);
      const vOrders = orders.filter(o => o.visitId === visitObj.id);

      let ordersText = "";
      if (vOrders.length) {
        ordersText += "\nORDERS FOR THIS VISIT:\n";
        vOrders.forEach(o => {
          ordersText += `- ${o.type}: ${o.name || ""} | Ordered: ${o.orderedDate || ""} | Status: ${o.status || ""}`;
          if (o.resultDate || o.resultText) ordersText += ` | Result: ${o.resultDate || ""} ${o.resultText || ""}`;
          ordersText += "\n";
        });
      }

      const combined = `${note}\n${ordersText}`.trim();
      const safeCombined = combined.replace(/</g, "&lt;").replace(/>/g, "&gt;");

      return `
        <div class="print-block">
          <div class="print-title">Al Farabi Pediatric GI – Visit Note</div>
          <div class="print-subtitle">
            <strong>Patient:</strong> ${p.nameEn || ""} &nbsp; | &nbsp;
            <strong>DOB:</strong> ${p.dob || "N/A"} &nbsp; | &nbsp;
            <strong>Visit date:</strong> ${visitObj.date || ""}
          </div>
          <div class="print-small">Generated: ${new Date().toLocaleString()}</div>
          <hr />
          <pre>${safeCombined}</pre>
        </div>
      `;
    }

    // ====== PATIENTS ======
    function renderPatients(filter = "") {
      const list = document.getElementById("patientList");
      list.innerHTML = "";
      const q = filter.toLowerCase();
      patients
        .slice()
        .sort((a, b) => a.nameEn.localeCompare(b.nameEn))
        .forEach((p) => {
          if (
            q &&
            !(
              p.nameEn.toLowerCase().includes(q) ||
              (p.phone || "").toLowerCase().includes(q) ||
              (p.id || "").toLowerCase().includes(q)
            )
          ) {
            return;
          }
          const li = document.createElement("li");
          li.className =
            "list-group-item list-group-item-action patient-item py-1";
          if (p.id === selectedPatientId) li.classList.add("active");
          li.innerHTML = `
            <div class="fw-semibold">${p.nameEn}</div>
            <div class="small text-muted">${p.id || ""} ${
            p.phone ? " · " + p.phone : ""
          }</div>
          `;
          li.onclick = () => {
            selectedPatientId = p.id;
            renderPatients(document.getElementById("patientSearch").value);
            showPatientDetail();
          };
          list.appendChild(li);
        });
    }

    function getPatientById(id) {
      return patients.find((p) => p.id === id);
    }

    function showPatientDetail() {
      const detail = document.getElementById("patientDetail");
      const none = document.getElementById("noPatientSelected");
      const patient = getPatientById(selectedPatientId);
      if (!patient) {
        detail.classList.add("d-none");
        none.classList.remove("d-none");
        return;
      }
      none.classList.add("d-none");
      detail.classList.remove("d-none");

      document.getElementById("detailName").textContent = patient.nameEn;
      document.getElementById(
        "detailId"
      ).textContent = `${patient.id || ""} · ${
        patient.phone || ""
      }`.trim();

      const dob = patient.dob ? `DOB: ${patient.dob}` : "";
      const sex = patient.sex ? `Sex: ${patient.sex}` : "";
      const city = patient.city ? `City: ${patient.city}` : "";
      document.getElementById(
        "detailDemographics"
      ).textContent = [dob, sex, city].filter(Boolean).join(" · ");

      document.getElementById("chatgptPrompt").value = "";
      document.getElementById("aiSummaryEn").value = "";
      document.getElementById("aiSummaryAr").value = "";
      document.getElementById("aiSummaryKu").value = "";
      document.getElementById("aiError").textContent = "";
      currentVisitIdForOrders = null;
      lastSelectedVisit = null;
      renderVisitsForPatient();
      renderOrdersForVisit();
    }

    // ====== VISITS ======
    function renderVisitsForPatient() {
      const container = document.getElementById("visitList");
      container.innerHTML = "";
      if (!selectedPatientId) return;
      const patientVisits = visits
        .filter((v) => v.patientId === selectedPatientId)
        .sort((a, b) => (a.date || "").localeCompare(b.date));

      if (!patientVisits.length) {
        container.innerHTML =
          '<div class="text-muted small">No visits recorded yet.</div>';
        return;
      }

      patientVisits.forEach((v) => {
        const card = document.createElement("div");
        card.className = "card visit-card";
        card.innerHTML = `
          <div class="card-body py-2">
            <div class="d-flex justify-content-between">
              <div>
                <div class="fw-semibold">${v.date || ""} – ${v.type || ""}</div>
                <div class="small text-muted">${v.cc || ""}</div>
              </div>
              <button class="btn btn-outline-secondary btn-sm">Details</button>
            </div>
          </div>
        `;
        card
          .querySelector("button")
          .addEventListener("click", () => showVisitPrompt(v));
        container.prepend(card); // newest on top
      });
    }

    function makeClinicalNoteText(patient, v) {
      return `
PATIENT:
- Name: ${patient ? patient.nameEn : ""}
- ID: ${patient ? patient.id : ""}

CLINICAL NOTE:
- Date: ${v.date}
- Visit type: ${v.type}
- Chief complaint: ${v.cc}

HPI:
${v.hpi}

Past history / meds / allergies:
${v.pmh}

Vitals:
${v.vitals}

Exam (GI and other):
${v.exam}
${v.otherExam}

Impression / diagnosis:
${v.impression}

Plan – Investigations:
${v.planInvestigations}

Plan – Medications:
${v.planMeds}

Plan – Diet / counseling / follow-up:
${v.planCounsel}
`;
    }

    function showVisitPrompt(v) {
      const patient = getPatientById(v.patientId);
      currentVisitIdForOrders = v.id;
      lastSelectedVisit = v;
      renderOrdersForVisit();

      const text = `
You are a pediatric gastroenterologist helping a parent understand their child’s clinic visit.

Using the clinical note below, write THREE separate, parent-friendly summaries of this visit:

1) In ENGLISH.
2) In MODERN STANDARD ARABIC.
3) In KURDISH (clear, polite language understood by most patients in Iraqi Kurdistan).

For each language, use these headings (translate the headings appropriately in Arabic and Kurdish):
- Diagnosis
- What we think is going on
- Treatment / Medications
- Tests and follow-up
- Red flags (when to go to ER or contact doctor)

Please avoid medical jargon where possible and keep the style reassuring and clear.

${makeClinicalNoteText(patient, v)}
`;
      document.getElementById("chatgptPrompt").value = text.trim();
    }

    // ====== ORDERS ======
    function renderOrdersForVisit() {
      const listEl = document.getElementById("orderList");
      if (!listEl) return;
      listEl.innerHTML = "";
      if (!currentVisitIdForOrders) {
        listEl.innerHTML =
          '<div class="text-muted small">No visit selected yet. Click "Details" on a visit.</div>';
        return;
      }
      const thisOrders = orders.filter(
        (o) => o.visitId === currentVisitIdForOrders
      );
      if (!thisOrders.length) {
        listEl.innerHTML =
          '<div class="text-muted small">No orders for this visit yet.</div>';
        return;
      }
      thisOrders
        .slice()
        .sort((a, b) =>
          (a.orderedDate || "").localeCompare(b.orderedDate || "")
        )
        .forEach((o) => {
          const div = document.createElement("div");
          div.className = "border rounded p-1 mb-1";
          div.innerHTML = `
            <div><strong>${o.type}</strong> – ${o.name || ""}</div>
            <div>${o.orderedDate || ""} · Status: ${o.status || ""}</div>
            ${
              o.resultDate || o.resultText
                ? `<div class="text-muted">Result: ${o.resultDate || ""} ${
                    o.resultText ? "– " + o.resultText : ""
                  }</div>`
                : ""
            }
          `;
          listEl.appendChild(div);
        });
    }

    // ====== EXPORT PATIENT HISTORY ======
    function buildPatientHistoryText(patientId) {
      const p = getPatientById(patientId);
      if (!p) return "";
      const lines = [];
      lines.push(`PATIENT DEMOGRAPHICS`);
      lines.push(`Name (English): ${p.nameEn || ""}`);
      if (p.nameAr) lines.push(`Name (Arabic): ${p.nameAr}`);
      if (p.nameKu) lines.push(`Name (Kurdish): ${p.nameKu}`);
      lines.push(`Patient ID: ${p.id || ""}`);
      lines.push(
        `DOB: ${p.dob || "N/A"}    Sex: ${p.sex || ""}    City: ${
          p.city || ""
        }`
      );
      if (p.phone) lines.push(`Phone / WhatsApp: ${p.phone}`);
      if (p.referral) lines.push(`Referral source: ${p.referral}`);
      if (p.caregiver || p.caregiverRel)
        lines.push(
          `Primary caregiver: ${p.caregiver || ""} (${p.caregiverRel || ""})`
        );
      if (p.notes) lines.push(`Notes / Flags: ${p.notes}`);
      lines.push("");
      lines.push("CLINIC VISITS");
      const pVisits = visits
        .filter((v) => v.patientId === patientId)
        .sort((a, b) => (a.date || "").localeCompare(b.date));
      if (!pVisits.length) {
        lines.push("No visits recorded.");
      } else {
        pVisits.forEach((v, idx) => {
          lines.push("");
          lines.push(
            `Visit ${idx + 1}: ${v.date || ""} – ${v.type || ""} – ${
              v.cc || ""
            }`
          );
          if (v.hpi) lines.push(`HPI: ${v.hpi}`);
          if (v.pmh) lines.push(`Past history / Meds / Allergies: ${v.pmh}`);
          if (v.vitals) lines.push(`Vitals: ${v.vitals}`);
          if (v.exam || v.otherExam)
            lines.push(
              `Exam: ${v.exam || ""}${
                v.otherExam ? " | Other: " + v.otherExam : ""
              }`
            );
          if (v.impression) lines.push(`Impression / Diagnosis: ${v.impression}`);
          if (v.planInvestigations)
            lines.push(`Plan – Investigations: ${v.planInvestigations}`);
          if (v.planMeds) lines.push(`Plan – Medications: ${v.planMeds}`);
          if (v.planCounsel)
            lines.push(`Plan – Diet / Counseling / Follow-up: ${v.planCounsel}`);
          if (v.followInterval || v.nextDate)
            lines.push(
              `Follow-up: ${v.followInterval || ""}  Next appointment: ${
                v.nextDate || ""
              }`
            );

          const vOrders = orders.filter((o) => o.visitId === v.id);
          if (vOrders.length) {
            lines.push("Orders for this visit:");
            vOrders.forEach((o) => {
              lines.push(
                `  - ${o.type}: ${o.name || ""} | Ordered: ${
                  o.orderedDate || ""
                } | Status: ${o.status || ""}${
                  o.resultDate || o.resultText
                    ? ` | Result: ${o.resultDate || ""}${
                        o.resultText ? " – " + o.resultText : ""
                      }`
                    : ""
                }`
              );
            });
          }
        });
      }
      return lines.join("\n");
    }

    // ====== INIT EMR APP (after PIN) ======
    let emrInitialized = false;
    function initEmrApp() {
      if (emrInitialized) return;
      emrInitialized = true;

      loadData();
      renderPatients();

      // patient search
      document
        .getElementById("patientSearch")
        .addEventListener("input", (e) => {
          renderPatients(e.target.value);
        });

      // patient modal show
      document
        .getElementById("patientModal")
        .addEventListener("show.bs.modal", () => {
          const editIndex
          
